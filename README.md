# ha-cluster

## pgbouncer

дополнительно, настройка с pgbauncer есть в конфигурационных файлах. и там все очень просто,
* Посмотрите здесь конфигурационный файл https://bitbucket.org/big-town/ha-cluster/src/master/pg_cluster/ha-proxy/ceph_pp_haproxy_1/haproxy.cfg.pool я думаю все станет понятно.
* В двух словах pgbouncer ставится за ha-proxy, в примере он установлен на каждой ноде postgres.
* Только помните, что pgbouncer эффективен когда у вас много клиентов работает коннект/дисконнект, если у вас бэкенд работает по персистентным соединениям, то от pgbouncer не будет ни какого толку.

## patroni

* Можно расположить etcd, patroni и postgresql на одной машине? Чтобы уменьшить количество серверов?
* Можно, единственное требование к etcd что бы они располагались на разных серверах, но в целом так не правильно делать
  * 3 сервера etcd (а иногда и 5) используется для кворума, для правильного и наиболее устойчивого к ошибкам метода определения, что одна из нод postgres отвалилась. Если у вас вместе с postgres отваливается и etcd - это не гуд совершенно.
  * etcd пишет ключи-значения на диск. Это такая конвенция. Если у вас postgres в моменте будет сильно нагружен - не факт, что сервер etcd отработает так, как нужно и с минимальными задержками.

  Итого: так делать можно, но на проде нужно использовать отдельные серваки для etcd. Можно брать самые слабые, но на них ничего другого быть не должно, кроме etcd ну и может быть в редких случая самых легковесных приложений.

## pgbench

```
sync && echo 1 > /proc/sys/vm/drop_caches &&
psql -U postgres -p 5432 -c "drop database test;" &&
psql -U postgres -p 5432 -c "checkpoint;" &&
psql -U postgres -p 5432 -c "create database test;" &&
pgbench -i -s 100 -U postgres test &&
pgbench -c 100 -t 100 -j 40 -U postgres test
```
